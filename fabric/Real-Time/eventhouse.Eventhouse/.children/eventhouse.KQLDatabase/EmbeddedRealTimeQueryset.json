{
  "queryset": {
    "version": "1.0.0",
    "dataSources": [
      {
        "id": "ee0990e9-891e-4272-b171-01f16356bc82",
        "clusterUri": "https://trd-64402wcfv837yzr036.z9.kusto.fabric.microsoft.com",
        "type": "Fabric",
        "databaseItemId": "751b8962-6c5d-4816-aea5-24d888ea4d55",
        "databaseItemName": "eventhouse"
      }
    ],
    "tabs": [
      {
        "id": "e9248ffa-3b59-4b4d-a9ea-ec7e68448418",
        "content": ".create-or-alter function with (folder=\"viz\") routes_vehicles()\n{\nlet route_base =\n    tb_route_segments\n    | extend latitude = todouble(latitude), longitude = todouble(longitude), sequence = toint(sequence)\n    | sort by route_id asc, sequence asc\n    | summarize\n        wkt = strcat(\n            \"LINESTRING(\",\n            strcat_array(make_list(strcat(longitude, \" \", latitude)), \", \"),\n            \")\"\n        )\n      by route_id;\nlet telem =\n    tb_vehicles_telemetry\n    | extend latitude = todouble(latitude), longitude = todouble(longitude), progress_pct = toint(progress_pct), speed_kmh = todouble(speed_kmh), timestamp = todatetime(timestamp);\ntelem\n| join kind=leftouter (route_base) on route_id\n| project\n    route_id,\n    vehicle_id,\n    latitude,\n    longitude,\n    sequence,\n    timestamp,\n    progress_pct,\n    speed_kmh,\n    status,\n    icon_map = \"https://img.icons8.com/?size=100&id=14739&format=png&color=000000\",\n    key = strcat(route_id, \"-\", tostring(sequence), \"-\", \"img\")\n| union (\n    telem\n    | join kind=leftouter (route_base) on route_id\n    | project\n        route_id,\n        vehicle_id,\n        latitude = 0.0/0.0,\n        longitude = 0.0/0.0,\n        sequence,\n        timestamp,\n        progress_pct,\n        speed_kmh,\n        status,\n        icon_map = wkt,\n        key = strcat(route_id, \"-\", tostring(sequence), \"-\", \"wkt\")\n)\n| order by route_id asc, timestamp asc, sequence asc    \n}",
        "title": "routes_vehicles_function",
        "dataSourceId": "ee0990e9-891e-4272-b171-01f16356bc82"
      },
      {
        "id": "b9fea4cc-5c64-45ce-a60d-2c9d2fc96209",
        "content": "tb_vehicles_telemetry\n| where route_id  == \"23fe76a0-450e-4731-9c39-dfc7ed66c4aa\"",
        "title": "",
        "dataSourceId": "ee0990e9-891e-4272-b171-01f16356bc82"
      },
      {
        "id": "7c82b282-051a-4058-be18-449270dbf5cb",
        "content": ".create-or-alter function with (folder = \"gold\", docstring = \"Vehicles telemetry + route WKT\", skipvalidation = \"true\") vehicles_telemetry_gold() {\n    tb_vehicles_telemetry_silver\n  | join kind=leftouter tb_routes_wkt_silver on route_id\n  | project\n      route_id, \n      vehicle_id, \n      latitude, \n      longitude, \n      sequence, \n      timestamp, \n      progress_pct, \n      speed_kmh, \n      status, \n      wkt,\n      key = strcat(route_id, \"-\", tostring(sequence), \"-\", iif(isnotempty(wkt), \"wkt\", \"img\"))\n  | order by route_id asc, timestamp asc, sequence asc\n}\n\n.create-or-alter materialized-view mv_latest_telem on table tb_vehicles_telemetry_silver {\n    tb_vehicles_telemetry_silver\n    | extend icon_map = \"https://img.icons8.com/?size=100&id=14739&format=png&color=000000\"\n    | summarize arg_max(timestamp, *) by vehicle_id\n}\n\n",
        "title": "",
        "dataSourceId": "ee0990e9-891e-4272-b171-01f16356bc82"
      }
    ]
  }
}